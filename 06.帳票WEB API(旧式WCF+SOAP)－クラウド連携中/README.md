※Visual Studio 2022では、Shift+F7 でこのREADME.md をプレビュー表示してください。

※Visual Studio 2019以前ではMarkdownプレビュー機能はありません。  
※プレビューが必要な場合は、Visual Studio Code等の外部ツールをご利用ください。
<br>
# Reports.net WCF+SOAP Web API サンプルアプリケーション (.NET Framework用)

## フォルダとソリューション構成

```
06.帳票WEB API(旧式WCF+SOAP)－クラウド連携中
  ├── SoapService.sln         - WCF+SOAP API + クライアント統合
  ├── README.md               - このファイル
  │
  ├── Client/                 - 帳票出力クライアントプロジェクト
  │    ├── ClientForm/        - Windows Form版クライアント
  │    └── ClientWpf/         - WPF版クライアント
  │
  └── SoapService/            - 帳票作成 WCF+SOAP API プロジェクト
       └── App_Data/          - コントローラで利用する帳票デザイン・画像
```

## 📋 概要

本サンプルプログラムは、**レガシーなWCF+SOAP**を利用した帳票出力SOAPサービスプログラムです。

> ⚠️ **重要**: これは**.NET Framework用のWCF-SOAPサービス参考プログラム**です。  
> **.NET 5 ～ .NET 9以降用ではありません**。

### 🆚 REST API版との違い

| 項目 | **WCF+SOAP版（このサンプル）** | **REST API版** |
|------|------------------------------|----------------|
| **プロトコル** | SOAP over HTTP | REST over HTTP |
| **データ形式** | XML | JSON |
| **対象フレームワーク** | .NET Framework 4.5～4.8 | .NET 5～9 |
| **用途** | レガシーシステム連携 | モダンアプリケーション |

## クイックスタート

### 🚀 ローカル開発環境での実行（推奨）

1. **ソリューションを選択して起動**:
   - `WcfApp.sln` を開く
   
2. **F5キーで実行**:
   - **Visual Studio 2019/2022**: **3つのプロジェクトが同時に起動**されます
   - **Visual Studio 2017以前**: 各プロジェクトを個別に起動してください

> **Visual Studio 2017以前をご利用の場合**
> 
> マルチスタートアップ機能がないため、以下の順序で個別に起動してください：
> 1. SorpService プロジェクトを右クリック → 「デバッグ」→「新しいインスタンスを開始」
> 2. ClientForm プロジェクトを右クリック → 「デバッグ」→「新しいインスタンスを開始」  
> 3. ClientWpf プロジェクトを右クリック → 「デバッグ」→「新しいインスタンスを開始」

3. **帳票出力**:
   - Windows Form/WPF いずれかお好みのクライアントを選択
   - 「ローカルデバッグ環境」を選択
   - 「実行」ボタンをクリック

### ☁️ クラウド環境利用

1. **クライアントのみ起動**:
   - 上記の手順でクライアントが起動したら、クラウド環境を選択：
     - ローカルデバッグ環境
     - Azure クラウド環境

2. **帳票出力**:
   - 「実行」ボタンをクリック

---

## 🚨 トラブルシューティング

### プロジェクトが読み込めない・起動できない場合

#### A. 【最優先】OneDriveによるIIS Express エラー（2025年現在の主要原因）

**🎯 症状**
- ソリューション(.sln)を開くとプロジェクトが「アンロード済み」として灰色表示される
- プロジェクトを直接開くとエラー発生：
  - ファイル名: redirection.config
  - エラー: 構成ファイルを読み取れません

**🔍 原因**  
OneDriveがDocumentsフォルダーを管理している場合、IIS Expressの設定ファイルが「オンラインのみ」状態になり、ローカルで利用できなくなることがある。Windows Update後に発生しやすい問題です。

> ⚠️ **重要**: .NET Framework環境でもVisual Studioのデバッグ実行時はIIS Expressが使用されるため、同様の問題が発生します。

**✅ 解決方法（推奨⭐）**
1. エクスプローラーを開く
2. 以下のパスを確認：
   - `C:\Users\[ユーザー名]\OneDrive\Documents\IISExpress`
   - `C:\Users\[ユーザー名]\Documents\IISExpress`
3. `C:\Users\[ユーザー名]\OneDrive\Documents\IISExpress`フォルダーを右クリック
4. 「このデバイス上に常に保持する」を選択
5. パソコンを再起動

#### B. WCF+SOAP特有のエラー

**🎯 症状**
- 「受信メッセージの最大メッセージ サイズ クォータ (65536) を超えました」エラー

**✅ 解決方法**
このサンプルでは既に対処済みです。大きなデータの送受信が可能になっています。

**🎯 症状**
- WCFサービス参照エラー

**✅ 解決方法**
1. SorpServiceプロジェクトが起動していることを確認
2. ブラウザで `http://localhost:62141/Service1.svc` にアクセスできることを確認
3. クライアントプロジェクトで接続先を適切に選択

---

## 処理の流れ

```
Windows Forms/WPF
クライアント ──[SOAP要求]─→ SOAPサービス
     ↓                         │
【帳票出力】 ←──[SOAP応答]─────┘
```

1. クライアント（Windows Form/WPF）→(SOAP要求で印刷データ作成依頼)→サーバサイド(SOAPサービス)
2. サーバサイド(SOAPサービス)→(SOAP応答で印刷データ)→クライアント→帳票出力

このソリューションには、SOAPサービスと2種類のクライアント（Windows Form版・WPF版）が含まれています。

デフォルトでは、ソリューションのマルチプルスタートアップ設定により、F5キーを押すことで
「SOAPサービス」「Windows Form版クライアント」「WPF版クライアント」の3つが同時に起動されます。
Windows Form/WPF いずれかお好みのクライアントをご利用ください。

※SOAPサービスプロジェクトが先に起動し、ブラウザで「WCFサービス」のページが表示されます。

プログラム起動後は、SOAPサービスの配置場所を選択してください：
[ローカルデバッグ環境 / Azure クラウド環境]

配置場所と「出力帳票の種類」を選択後、「実行」ボタンをクリックすると
SOAPサービスから印刷データを取得し、帳票出力を行います。

## WCF+SOAP vs REST API の技術比較

| 技術要素 | **WCF+SOAP** | **REST API** |
|----------|--------------|--------------|
| **プロトコル** | SOAP over HTTP | HTTP |
| **メッセージ形式** | XML | JSON |
| **契約定義** | WSDL | OpenAPI/Swagger |
| **相互運用性** | 高い（標準準拠） | 高い（シンプル） |
| **パフォーマンス** | 重い（XMLオーバーヘッド） | 軽い |
| **セキュリティ** | WS-Security | HTTP/TLS |
| **開発の容易さ** | 複雑 | シンプル |

> 📝 **Note**: WCF+SOAPは古い技術ですが、企業システムでの実績とセキュリティ機能が豊富です。

## よくある質問 (FAQ)

**Q: 3つのプロジェクトが同時に起動しますが、どれを使えばよいですか？**  
A: SOAPサービスプロジェクトは開発用インターフェースです。実際の帳票出力には Windows Form または WPF のいずれかお好みのクライアントをご利用ください。

**Q: サーバーサイドのWCF+SOAP APIを起動するとブラウザが開きますが、何をすればよいですか？**  
A: これはWCFサービスの開発用インターフェースです。特に操作は不要で、クライアントアプリから利用されます。

**Q: REST API版との違いは何ですか？**  
A: 主な違いは通信プロトコル（SOAP vs REST）とデータ形式（XML vs JSON）です。WCF-SOAP版はレガシーシステム連携に適しています。

**Q: クラウド環境のAPIにアクセスできない場合は？**  
A: クラウド環境は予告なく停止する場合があります。その場合は、ローカル環境でサーバーを実行してください。

**Q: プロジェクトが起動しない場合は？**  
A: 上記の「トラブルシューティング」セクションをご確認ください。OneDriveによるIIS Express問題が最も多い原因です。

**Q: 「受信メッセージの最大メッセージ サイズ クォータを超えました」エラーが出ます**  
A: このサンプルでは既に対処済みです。サーバー・クライアント双方でメッセージサイズ制限を拡張しています。

**Q: ローカル環境で接続エラーが発生します**  
A: SOAPサービスが起動していることを確認してください。マルチプルスタートアップ設定により、通常は自動的に起動されます。

## レガシー技術学習の価値

WCF-SOAPは古い技術ですが、以下の学習価値があります：

- **型安全性の確保**: WSDLによる厳密な型定義でコンパイル時エラー検出、JSONの動的型変換によるランタイムエラーを防止
- **依存関係の簡潔性**: .NET Framework標準搭載でNuGetパッケージ地獄を回避、アセンブリだけで完結する軽量な構成
- **企業システム理解**: 多くの企業システムで現役稼働中
- **通信プロトコル理解**: SOAPの仕組みとXMLメッセージング
- **セキュリティ理解**: WS-Securityなどエンタープライズセキュリティ
- **マイグレーション技術**: レガシーシステムのモダン化対応
- **自動コード生成**: サービス参照により型安全なプロキシクラスを自動生成、手動でのHTTPクライアント実装が不要
- **トランザクション対応**: 分散トランザクション（WS-AtomicTransaction）のネイティブサポート
- **標準化されたエラー処理**: SOAPフォルトによる統一されたエラー情報、RESTのHTTPステータスコード解釈の曖昧さを回避
- **企業間連携の実績**: 金融・製造業などミッションクリティカルなB2B通信での豊富な運用実績

特に「**型の明確性**」と「**依存関係の少なさ**」は、現代の複雑な開発環境において再評価されるべき価値です。

## チュートリアル動画

> 📹 **Note**: WCF+SOAP専用の動画は準備中です。REST API版の動画も参考になります。

1. [最短/最速 REST API実装 GET編](https://youtu.be/cYEtHFpa8G4)
2. [最短/最速 REST API実装 POST編](https://youtu.be/EflMRmMYU4A)
3. [Visual Studio から IISへデプロイ手順](https://youtu.be/xHNLlPuMFEs)
4. [REST APIで帳票作成](https://youtu.be/Bolfww56aWY)

---

> 📝 **Note**: このサンプルは**レガシーなWCF+SOAP Web API**用です。  
> モダンな開発には**REST API版**のご利用をお勧めします。

----

© Reports.net - クラウド対応帳票出力ソリューション